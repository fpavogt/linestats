# This workflow will check that the code version was increased.
#
# Copyright (c) 2022 MeteoSwiss, created by F.P.A. Vogt; frederic.vogt@meteoswiss.ch

name: CI_check_version

on:
  pull_request:
    branches: [ master, develop ]

jobs:
  version:

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:

    - name: Checkout current repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependancies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools
      shell: bash

    - name: wget the HEAD and BASE version files
      run: |
        export VERSION_LOC=linestats/version.py
        wget -O head_version.tmp https://raw.githubusercontent.com/$GITHUB_REPOSITORY/$GITHUB_HEAD_REF/$VERSION_LOC
        wget -O base_version.tmp https://raw.githubusercontent.com/$GITHUB_REPOSITORY/$GITHUB_BASE_REF/$VERSION_LOC
      shell: bash

    - name: Check if the version was increased
      run: |
        HEAD_VERSION="$(grep version head_version.tmp | grep -o '[[:alnum:]]*\.[[:alnum:]]*\.[[:alnum:]]*')"
        echo "HEAD_VERSION:" $HEAD_VERSION
        BASE_VERSION="$(grep version base_version.tmp | grep -o '[[:alnum:]]*\.[[:alnum:]]*\.[[:alnum:]]*')"
        echo "BASE_VERSION:" $BASE_VERSION
        python ./.github/workflows/check_version.py $HEAD_VERSION $BASE_VERSION
      shell: bash
